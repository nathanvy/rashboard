<div class="dashboard">
  <h1>Zalgo Performance</h1>

<div class="equity-curve">
  <canvas id="equityChart" height="100"></canvas>
</div>

<%= javascript_include_tag "https://cdn.jsdelivr.net/npm/chart.js" %>
<%= javascript_include_tag "https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns" %>

<script>
  document.addEventListener("DOMContentLoaded", function() {
    const equityData = <%= raw @equity_series.to_json %>;
    const chartPoints = equityData.map(([t, pnl]) => ({ x: t, y: pnl }));
    const ctx = document.getElementById("equityChart").getContext("2d");
    new Chart(ctx, {
      type: "line",
      data: {
        datasets: [{
          label: "Realized P&L",
          data: chartPoints,
          fill: false,
          borderWidth: 2,
        }]
      },
      options: {
        scales: {
          x: {
            type: "time",
            time: {
              unit: "minute",
              tooltipFormat: "MMM d, yyyy HH:mm"
            },
            title: { display: true, text: "Time" }
          },
          y: {
            beginAtZero: true,
            title: { display: true, text: "Cumulative P&L" }
          }
        },
        plugins: {
          legend: { display: true },
          tooltip: { mode: "index", intersect: false }
        },
        elements: {
          point: { radius: 0 }  // hide the dots for a smoother line
        },
        responsive: true,
        maintainAspectRatio: false
      }
    });
  });
</script>

<h2>Transactions</h2>
<div class="table-container">
  <table class="table">
    <thead>
      <tr>
        <% if @trades.any? %>
          <% @trades.first.attributes.keys.each do |col| %>
            <th><%= col.titleize %></th>
          <% end %>
        <% else %>
          <th>No transactions available</th>
        <% end %>
      </tr>
    </thead>
    <tbody>
      <% @trades.each do |trade| %>
        <tr>
          <% trade.attributes.values.each do |val| %>
            <td><%= val %></td>
          <% end %>
        </tr>
      <% end %>
    </tbody>
  </table>
</div>

<h2>Completed Trades</h2>
<div class="table-container">
  <table class="table">
    <thead>
      <tr>
        <% @completed_columns.each do |col| %>
        <th><%= @completed_column_labels[col].html_safe %></th>
        <% end %>
      </tr>
    </thead>
    <tbody>
      <% @completed.each do |c| %>
        <tr>
          <% @completed_columns.each do |col| %>
          <td>
            <% value = c[col] %>
            <% case col
               when :expiry then concat l(value, format: :short)
               when :open_price, :close_price, :dPnL, :deltaPL, :thetaPL, :vegaPL, :gammaPL, :residual
               then concat number_with_precision(value, precision: 2)
               else
               concat value
               end %>
          </td>
          <% end %>
        </tr>
      <% end %>
    </tbody>
  </table>
</div>
</div>
